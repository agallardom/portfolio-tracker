generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}


model Portfolio {
  id           String        @id @default(uuid())
  name         String
  currency     String        // "USD" or "EUR"
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  userId       String
  user         User          @relation(fields: [userId], references: [id])

  transactions Transaction[]
}


model Asset {
  symbol            String        @id
  isin              String?       @unique // Trade Republic Import support
  name              String?
  assetClass        String?       @default("EQUITY") // "EQUITY", "FIXED_INCOME", "CASH", "CRYPTO"
  currentPrice      Float?        // Price in quote currency
  quoteCurrency     String?       // Currency the asset trades in (EUR, USD, etc.)
  exchangeRateToUSD Float?        // Exchange rate to USD
  exchangeRateToEUR Float?        // Exchange rate to EUR
  updatedAt         DateTime      @updatedAt
  transactions      Transaction[]
}

model Transaction {
  id           String   @id @default(uuid())
  date         DateTime
  type         String   // "BUY", "SELL", "DIVIDEND", "SAVEBACK", "ROUNDUP", "GIFT"
  
  // Amounts in portfolio currency
  amount       Float    // Total value in portfolio currency
  currency     String   // Portfolio currency (should match Portfolio currency)
  
  // Asset info (optional for SaveBack etc)
  assetSymbol  String?
  asset        Asset?   @relation(fields: [assetSymbol], references: [symbol])
  
  // Price and quantity
  pricePerUnit Float?   // Price per unit in portfolio currency
  quantity     Float?
  
  fee          Float?   @default(0)
  
  // Multi-currency transaction data
  exchangeRate Float?   @default(1.0) 
  originalCurrency String?  // Currency used for the transaction (e.g., EUR)
  originalAmount   Float?   // Amount in original currency
  
  // Asset-specific currency tracking
  assetCurrency              String?  // Currency the asset trades in (e.g., EUR for SAN.MC)
  pricePerUnitInAssetCurrency Float?  // Price per unit in asset's native currency

  // Dividend Tax Details
  withholdingTax Float?   // Tax withheld in portfolio currency
  taxRate        Float?   // Tax rate percentage (e.g. 19.0)
  isin           String?  // ISIN code of the asset

  portfolioId  String
  portfolio    Portfolio @relation(fields: [portfolioId], references: [id])

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  role          String    @default("USER") // "ADMIN", "USER"
  mfaEnabled    Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  portfolios    Portfolio[]
  riskProfile   RiskProfile?
}

model InvitationToken {
  id        String   @id @default(uuid())
  token     String   @unique
  email     String   @unique // One pending invitation per email
  status    String   @default("ACTIVE") // "ACTIVE", "USED", "EXPIRED"
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RiskProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id])
  score       Int
  profile     String   // "Conservative", "Moderate", "Balanced", "Dynamic", "Aggressive"
  
  // Detailed answers can be stored here or in a separate table if we want question-level granularity.
  // Storing as JSON string or keeping it simple for now; User request says "Cuestionario... Data Gathering".
  // Let's store the breakdown.
  answers     String   // JSON string of answers e.g. { "q1": 5, "q2": 3 ... }
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
